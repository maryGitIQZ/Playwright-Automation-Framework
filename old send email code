import { exec } from "child_process";
import nodemailer from "nodemailer";
import archiver from "archiver";
import fs from "fs";
import path from "path";

const REPORT_DIR = "allure-report";
const ZIP_FILE = "allure-report.zip";

function zipReport(): Promise<void> {
  return new Promise((resolve, reject) => {
    const output = fs.createWriteStream(ZIP_FILE);
    const archive = archiver("zip", { zlib: { level: 9 } });

    output.on("close", () => resolve());
    archive.on("error", (err) => reject(err));

    archive.pipe(output);
    archive.directory(REPORT_DIR, false);
    archive.finalize();
  });
}

async function sendEmail(status: "PASS" | "FAIL") {
  const transporter = nodemailer.createTransport({
    service: "gmail",
    auth: {
      user: "campntest25@gmail.com",
      pass: "zpal tpuw ejyc ebfo" // Gmail App Password
    }
  });

  const subject =
    status === "PASS"
      ? " Playwright Automation - Test Execution PASSED"
      : " Playwright Automation - Test Execution FAILED";

  const body = `
Hi Team,

Playwright automation execution for Get In Touch section is completed.

Execution Status: ${status}

Please find the attached Allure report for detailed results.

Regards,
Automation Team
`;

  await transporter.sendMail({
    from:`"Automation" campntest25@gmail.com`,
    to: "rmcrun1@gmail.com",
    subject,
    text: body,
    attachments: [
      {
        filename: "allure-report.html",
        path: "allure-report/index.html"
      }
    ] 
  });
}

console.log("Starting Playwright test execution...");

exec("npx playwright test", (error) => {
  const status: "PASS" | "FAIL" = error ? "FAIL" : "PASS";
  console.log(`Test Execution Status: ${status}`);

  console.log("Generating Allure report...");
  exec(
    "npx allure generate allure-results --clean -o allure-report",
    async () => {
      await zipReport();
      await sendEmail(status);
      console.log(" Test report emailed successfully");
    }
  );
});


